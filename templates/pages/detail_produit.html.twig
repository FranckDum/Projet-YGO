{% extends 'base.html.twig' %}

{% block title %}Détails du produit: {{ produit.nomProduit }}{% endblock %}

{% block h1 %}Détails du produit : {{ produit.nomProduit }}{% endblock %}

{% block body %}
<main class="container mx-auto p-2">
{% for carte in apiProduits %} 
    {% if carte.id == produit.ygoId %}
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="bg-dark rounded-custom p-3">
                        <div class="row">
                            <div class="col-md-4">
                                <img class="img-fluid" src="/Images/ImgCartes/normal/{{ carte.id }}.jpg" alt="{{ produit.nomProduit }}">
                            </div>
                            <div class="col-md-8">
                                <h2 class="text-center text-warning">{{ produit.nomProduit }}</h2>
                                <h3 class="mt-3 text-warning">Description :</h3>
                                <div class="mt-3 lead text-white">{{ carte.desc }}</div>
                                {% if carte.type is defined %}
                                    <h3 class="mt-3 text-warning">Type :</h3>
                                    <div class="mt-3 lead text-white">
                                        {% set type_translation = {
                                            'Effect Monster': 'Monstre à Effet',
                                            'Flip Effect Monster': 'Monstre à Effet Retourné',
                                            'Flip Tuner Effect Monster': 'Monstre à Effet Retourné Tuner',
                                            'Gemini Monster': 'Monstre Gemini',
                                            'Normal Monster': 'Monstre Normal',
                                            'Normal Tuner Monster': 'Monstre Normal Tuner',
                                            'Pendulum Effect Monster': 'Monstre à Effet Pendule',
                                            'Pendulum Effect Ritual Monster': 'Monstre à Effet Pendule Rituel',
                                            'Pendulum Flip Effect Monster': 'Monstre à Effet Pendule Retourné',
                                            'Pendulum Normal Monster': 'Monstre Pendule Normal',
                                            'Pendulum Tuner Effect Monster': 'Monstre à Effet Pendule Tuner',
                                            'Ritual Effect Monster': 'Monstre à Effet Rituel',
                                            'Ritual Monster': 'Monstre Rituel',
                                            'Spell Card': 'Carte Magie',
                                            'Spirit Monster': 'Monstre Spirituel',
                                            'Toon Monster': 'Monstre Toon',
                                            'Trap Card': 'Carte Piège',
                                            'Tuner Monster': 'Monstre Tuner',
                                            'Union Effect Monster': 'Monstre à Effet Union',
                                            'Fusion Monster': 'Monstre Fusion',
                                            'Link Monster': 'Monstre Lien',
                                            'Pendulum Effect Fusion Monster': 'Monstre Fusion à Effet Pendule',
                                            'Synchro Monster': 'Monstre Synchro',
                                            'Synchro Pendulum Effect Monster': 'Monstre à Effet Pendule Synchro',
                                            'Synchro Tuner Monster': 'Monstre Tuner Synchro',
                                            'XYZ Monster': 'Monstre XYZ',
                                            'XYZ Pendulum Effect Monster': 'Monstre à Effet Pendule XYZ'
                                        } %}
                                        {{ type_translation[carte.type] ?? carte.type }}
                                    </div>
                                {% endif %}
                                {% if carte.race is defined %}
                                    <h3 class="mt-3 text-warning">Race :</h3>
                                    <div class="mt-3 lead text-white">
                                        {% set race_translation = {
                                            'Aqua': 'Aqua',
                                            'Beast': 'Bête',
                                            'Beast-Warrior': 'Bête-Guerrier',
                                            'Creator-God': 'Créateur-Dieu',
                                            'Cyberse': 'Cyberse',
                                            'Dinosaur': 'Dinosaure',
                                            'Divine-Beast': 'Bête Divine',
                                            'Dragon': 'Dragon',
                                            'Fairy': 'Elfe',
                                            'Fiend': 'Démon',
                                            'Fish': 'Poisson',
                                            'Insect': 'Insecte',
                                            'Machine': 'Machine',
                                            'Plant': 'Plante',
                                            'Psychic': 'Psychique',
                                            'Pyro': 'Pyro',
                                            'Reptile': 'Reptile',
                                            'Rock': 'Rocher',
                                            'Sea Serpent': 'Serpent de Mer',
                                            'Spellcaster': 'Magicien',
                                            'Thunder': 'Tonnerre',
                                            'Warrior': 'Guerrier',
                                            'Winged Beast': 'Bête Ailée',
                                            'Wyrm': 'Wyrm',
                                            'Zombie': 'Zombie',
                                            'Normal': 'Normal',
                                            'Field': 'Terrain',
                                            'Equip': 'Équipement',
                                            'Continuous': 'Continue',
                                            'Quick-Play': 'Jeu Rapide',
                                            'Ritual': 'Rituel',
                                            'Counter': 'Contre'
                                        } %}
                                        {{ race_translation[carte.race] ?? carte.race }}
                                    </div>
                                {% endif %}
                                {% if carte.attribute is defined %}
                                    <h3 class="mt-3 text-warning">Attribut :</h3>
                                    <div class="mt-3 lead text-white">
                                        {% set attribute_translation = {
                                            'DIVINE': 'Divin',
                                            'WATER': 'Eau',
                                            'FIRE': 'Feu',
                                            'LIGHT': 'Lumière',
                                            'EARTH': 'Terre',
                                            'DARK': 'Ténèbres',
                                            'WIND': 'Vent'
                                        } %}
                                        {{ attribute_translation[carte.attribute] ?? carte.attribute }}
                                    </div>
                                {% endif %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mt-3 lead text-white"><span class="text-warning">Prix :</span> {{ produit.prix|number_format(2) }} €</div>
                                    </div>
                                </div>
                                <div class="col-md-3 ms-auto mb-3">
                                    {% set searchPanier = searchIdProduit(produit.id) %}
                                    {% if produit.Stock %}
                                        {% set quantity = produit.Stock %}
                                        {% if produit.Stock > 10 %}
                                            {% set quantity = 10 %}
                                        {% endif %}
                                        {% if searchPanier.search %}
                                            {% set quantity = quantity - searchPanier.q %}
                                        {% endif %}
                                        {% if quantity %}
                                        <form class="add-to-cart-form" method="post" action="{{ path("app_panier_new") }}">
                                            <select name="quantite" aria-label= "Bouton pour choisir la quantité de l'article à ajouter au panier">
                                            {% for i in 1 .. quantity %}
                                                <option value="{{i}}">{{i}}</option>
                                            {% endfor %}
                                            <input type="hidden" name="produit" value="{{produit.id}}" class="btn btn-success">
                                            <input type="hidden" name="nomProduit" value="{{produit.nomProduit}}" class="btn btn-success">
                                            <input type="submit" value="Ajouter au panier" class="btn btn-success rounded-custom">
                                        </form>
                                        {% else %}
                                            <p class="text-center text-danger">Quantité maximum autorisée.</p>
                                        {% endif %}
                                    {% else %}
                                        <h3 class="text-danger h3-custom text-center">Rupture de stock</h3>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}

<div id="flash-messages"></div>

{% if produitsSimilaires %}

            <div class="row d-flex justify-content-center flex-wrap mt-5">
            <h3 class="text-center text-warning">Vous avez choisi {{ produit.nomProduit }}, vous aimerez aussi :</h3>
                {% for produitSimilaire in produitsSimilaires %}
                    <div class="col-12 col-md-4 col-lg-2 d-flex flex-column align-items-center border border-3 border-opacity-50 border-black mx-3 my-3 rounded-custom bg-dark carte">
                        <a class="a" href="{{ path('detailProduit', {'id': produitSimilaire.id}) }}">
                            <h4 class="text-center text-warning">{{ produitSimilaire.nomProduit }}</h4>
                        </a>
                        <a class="a mt-auto" href="{{ path('detailProduit', {'id': produitSimilaire.id}) }}">
                            <div>
                            <img class="img-fluid mt-auto" src="/Images/ImgCartes/normal/{{ produitSimilaire.getYgoId() }}.jpg" alt="{{ produit.nomProduit }}">
                            </div>
                        </a>
                        <div>
                            <p class="card-text text-white mt-2">Prix : {{ produitSimilaire.prix|number_format(2) }} €</p>
                        </div>
                        <div class="ms-auto me-auto mb-3">
                            {% set searchPanier = searchIdProduit(produitSimilaire.id) %}
                            {% if produitSimilaire.Stock %}
                                {% set quantity = produitSimilaire.Stock %}
                                {% if produitSimilaire.Stock > 10 %}
                                    {% set quantity = 10 %}
                                {% endif %}
                                {% if searchPanier.search %}
                                    {% set quantity = quantity - searchPanier.q %}
                                {% endif %}
                                {% if quantity %}
                                <form class="add-to-cart-form" method="post" action="{{ path("app_panier_new") }}">
                                    <select name="quantite" aria-label= "Bouton pour choisir la quantité de l'article à ajouter au panier">
                                    {% for i in 1 .. quantity %}
                                        <option value="{{i}}">{{i}}</option>
                                    {% endfor %}
                                    <input type="hidden" name="produit" value="{{produitSimilaire.id}}" class="btn btn-success">
                                    <input type="hidden" name="nomProduit" value="{{produitSimilaire.nomProduit}}" class="btn btn-success">
                                    <input type="submit" value="Ajouter au panier" class="btn btn-success rounded-custom">
                                </form>
                                {% else %}
                                    <p class="text-center text-danger">Quantité maximum autorisée.</p>
                                {% endif %}
                            {% else %}
                                <h3 class="text-danger h3-custom text-center">Rupture de stock</h3>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
{% endif %}
</main>
{% endblock %}

{% block javascripts %}
    <script>
        // Ajouter produit au panier sans recharger la page et afficher un message flash
$(document).ready(function() {
    $('.add-to-cart-form').on('submit', function(event) {
        event.preventDefault(); // Empêche le formulaire de se soumettre normalement

        let formData = $(this).serialize(); // Sérialise les données du formulaire

        let flashKey = 'success_' + window.location.pathname;

        let quantiteValue = $(this).find('select[name="quantite"]').val();

        let productName = $(this).find('[name="nomProduit"]').val(); // Récupération du nom du produit depuis le formulaire

        $.ajax({
            method: 'POST',
            url: "{{ path('app_panier_new') }}",
            data: formData,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Ajout du message flash de succès avec le nom du produit
                    let flashMessage = $('<div class="alert alert-success" role="alert" data-flash-key="' + flashKey + '">L\'article "' + productName + '" a bien été ajouté au panier</div>');
                    $('#flash-messages').append(flashMessage);

                    let notifQuantitePanier = document.getElementById('notifQuantitePanier');
                    let notifQuantitePanierInt = parseInt(notifQuantitePanier.textContent);
                    if (isNaN(notifQuantitePanierInt)) {
                        notifQuantitePanierInt = 0;
                    }
                    quantiteValue = parseInt(quantiteValue);
                    console.log(typeof notifQuantitePanierInt);
                    console.log(typeof quantiteValue);
                    notifQuantitePanier.textContent = (notifQuantitePanierInt + quantiteValue);

                    // Disparition du message après 5 secondes
                    setTimeout(function() {
                        $('[data-flash-key="' + flashKey + '"]').fadeOut('slow', function() {
                            $(this).remove();
                        });
                    }, 5000);
                } else {
                    // Ajout du message d'erreur
                    let errorMessage = $('<div class="alert alert-danger" role="alert">' + response.message + '</div>');
                    $('#flash-messages').append(errorMessage);
                    
                    // Disparition du message d'erreur après 5 secondes
                    setTimeout(function() {
                        errorMessage.fadeOut('slow', function() {
                            $(this).remove();
                        });
                    }, 5000);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erreur lors de la requête AJAX:', error);
            }
        });
    });
});
    </script>
{% endblock %}

